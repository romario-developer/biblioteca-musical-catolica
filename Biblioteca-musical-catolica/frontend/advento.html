<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advento - HolyTracks</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&family=Poppins:wght@600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>
    <header class="main-header">
        <a href="index.html" class="logo">Holy<span>Tracks</span></a>
        <nav class="main-nav">
            <a href="index.html">Início</a>
            <a href="biblioteca.html">Biblioteca</a>
            <a href="repertorio.html">Repertório</a>
            <a href="participe.html" class="nav-button">Seja Membro</a>
        </nav>
    </header>

    <main class="main-container">
        <section class="page-header">
            <h1>Advento</h1>
            <p>Músicas para o tempo de preparação e esperança.</p>
        </section>

        <div id="moments-container" class="moments-grid">
            <p>Carregando momentos...</p>
        </div>
        
        <a href="index.html" class="back-button" style="margin: 3rem auto 0; display: table;">← Voltar para o Início</a>
    </main>

    <div id="music-list-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-category-title">Categoria</h2>
                <button class="close-modal-btn" onclick="closeModal( )">&times;</button>
            </div>
            <div id="modal-music-list" class="modal-body"></div>
            <div id="modal-pagination" class="pagination-container"></div>
        </div>
    </div>

    <script>
        const TEMPO_LITURGICO = 'Advento'; // Única variável a ser mudada por página

        document.addEventListener('DOMContentLoaded', async () => {
            const momentsContainer = document.getElementById('moments-container');
            try {
                const response = await fetch(`https://biblioteca-musical-catolica.onrender.com/api/momentos?tempo=${TEMPO_LITURGICO}` );
                if (!response.ok) throw new Error('Falha ao carregar momentos.');
                
                const momentos = await response.json();
                momentsContainer.innerHTML = '';

                const ordemMomentosMissa = ['Entrada', 'Ato Penitencial', 'Glória', 'Salmo', 'Aclamação', 'Ofertório', 'Santo', 'Cordeiro', 'Comunhão', 'Final'];
                momentos.sort((a, b) => {
                    const indexA = ordemMomentosMissa.indexOf(a);
                    const indexB = ordemMomentosMissa.indexOf(b);
                    if (indexA === -1 && indexB === -1) return a.localeCompare(b); // Ordena alfabeticamente os não listados
                    if (indexA === -1) return 1;
                    if (indexB === -1) return -1;
                    return indexA - indexB;
                });

                // Regra específica para Quaresma (exemplo)
                const momentosFiltrados = TEMPO_LITURGICO === 'Quaresma' ? momentos.filter(m => m !== 'Glória') : momentos;

                momentosFiltrados.forEach(momento => {
                    const item = document.createElement('div');
                    item.className = 'moment-item';
                    item.setAttribute('onclick', `openMusicList('${momento}')`);
                    item.innerHTML = `<h3>${momento}</h3>`;
                    momentsContainer.appendChild(item);
                });

            } catch (error) {
                momentsContainer.innerHTML = `<p style="color: red;">${error.message}</p>`;
            }
        });

        const modal = document.getElementById('music-list-modal');
        function closeModal() { modal.classList.remove('active'); }

        async function openMusicList(category, page = 1) {
            const modalTitle = document.getElementById('modal-category-title');
            const musicListContainer = document.getElementById('modal-music-list');
            const paginationContainer = document.getElementById('modal-pagination');

            musicListContainer.innerHTML = '<p>Carregando...</p>';
            paginationContainer.innerHTML = '';
            modal.classList.add('active');
            modalTitle.textContent = category;

            try {
                const limit = 5;
                const url = `https://biblioteca-musical-catolica.onrender.com/api/musicas?tempo=${encodeURIComponent(TEMPO_LITURGICO )}&momento=${encodeURIComponent(category)}&page=${page}&limit=${limit}`;
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                const songs = data.musicas;
                musicListContainer.innerHTML = '';

                if (songs.length > 0) {
                    songs.forEach(song => {
                        const item = document.createElement('div');
                        item.className = 'music-item';
                        const title = document.createElement('span');
                        title.className = 'music-title-span';
                        title.textContent = song.titulo;
                        item.appendChild(title);
                        const buttonsContainer = document.createElement('div');
                        buttonsContainer.className = 'action-buttons';
                        if (song.letraUrl) {
                            const letraLink = document.createElement('a');
                            letraLink.href = song.letraUrl;
                            letraLink.textContent = 'Letra';
                            letraLink.className = 'action-btn';
                            letraLink.setAttribute('target', '_blank');
                            buttonsContainer.appendChild(letraLink);
                        }
                        if (song.cifraUrl) {
                            const cifraLink = document.createElement('a');
                            cifraLink.href = song.cifraUrl;
                            cifraLink.textContent = 'Cifra';
                            cifraLink.className = 'action-btn';
                            cifraLink.setAttribute('target', '_blank');
                            buttonsContainer.appendChild(cifraLink);
                        }
                        const downloadLink = document.createElement('a');
                        downloadLink.href = song.downloadUrl;
                        downloadLink.textContent = 'Baixar';
                        downloadLink.className = 'action-btn';
                        downloadLink.setAttribute('target', '_blank');
                        downloadLink.setAttribute('download', '');
                        buttonsContainer.appendChild(downloadLink);
                        item.appendChild(buttonsContainer);
                        musicListContainer.appendChild(item);
                    });

                    if (data.totalPages > 1) {
                        for (let i = 1; i <= data.totalPages; i++) {
                            const pageBtn = document.createElement('button');
                            pageBtn.textContent = i;
                            pageBtn.className = 'pagination-btn';
                            if (i === data.currentPage) pageBtn.classList.add('active');
                            pageBtn.onclick = () => openMusicList(category, i);
                            paginationContainer.appendChild(pageBtn);
                        }
                    }
                } else {
                    musicListContainer.innerHTML = '<p>Nenhuma música encontrada para esta categoria.</p>';
                }
            } catch (error) {
                console.error('Erro ao buscar músicas:', error);
                musicListContainer.innerHTML = '<p>Ainda não há músicas para esta categoria.</p>';
            }
        }
    </script>
</body>
</html>
