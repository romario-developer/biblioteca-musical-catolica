<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Painel de Administração</title>
    <script>
        if (sessionStorage.getItem('isAuthenticated') !== 'true') {
            alert('Acesso negado. Por favor, faça o login.');
            window.location.href = 'login.html';
        }
    </script>
    <style>
        /* Seu CSS continua aqui, sem alterações */
        body { font-family: sans-serif; background-color: #f4f4f9; color: #333; padding: 2rem; }
        .container { max-width: 900px; margin: auto; background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #1a1a2e; margin-bottom: 1rem; }
        .tabs { display: flex; border-bottom: 2px solid #ddd; margin-bottom: 2rem; }
        .tab-button { padding: 1rem 1.5rem; cursor: pointer; border: none; background: none; font-size: 1.1rem; }
        .tab-button.active { border-bottom: 2px solid #ffd700; font-weight: bold; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .form-group { margin-bottom: 1rem; }
        label { display: block; margin-bottom: 0.5rem; font-weight: bold; }
        input, select, textarea { width: 100%; padding: 0.8rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem; }
        button { padding: 1rem; background-color: #ffd700; color: #1a1a2e; border: none; border-radius: 4px; font-size: 1.2rem; font-weight: bold; cursor: pointer; transition: background-color 0.2s; }
        #add-music-form button { width: 100%; }
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th, td { padding: 0.8rem; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #f9f9f9; }
        .actions button { font-size: 0.9rem; padding: 0.4rem 0.8rem; margin-right: 5px; }
        .btn-edit { background-color: #3498db; color: white; }
        .btn-delete { background-color: #e74c3c; color: white; }
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); }
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 2rem; border: 1px solid #888; width: 80%; max-width: 600px; border-radius: 8px; }
        .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>
    <div class="container">
        <button onclick="logout()" style="background-color: #e74c3c; color: white; width: auto; float: right;">Sair</button>
        <h1>Painel de Administração</h1>
        <div class="tabs">
            <button class="tab-button active" onclick="showTab('add')">Adicionar Música</button>
            <button class="tab-button" onclick="showTab('manage')">Gerenciar Músicas</button>
        </div>
        <div id="add" class="tab-content active">
            <h2>Adicionar Nova Música</h2>
            <form id="add-music-form"></form>
        </div>
        <div id="manage" class="tab-content">
            <h2>Músicas Cadastradas</h2>
            <table id="music-table">
                <thead>
                    <tr><th>Título</th><th>Tempo/Categoria</th><th>Momento</th><th>Ações</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeEditModal()">&times;</span>
            <h2>Editar Música</h2>
            <form id="edit-music-form"></form>
        </div>
    </div>

    <script>
        // --- CÓDIGO SCRIPT COMPLETO E CORRIGIDO ---
        const momentosPorCategoria = {
            'Advento': ['Entrada', 'Ato Penitencial', 'Glória', 'Aclamação', 'Ofertório', 'Santo', 'Comunhão', 'Final'],
            'Natal': ['Entrada', 'Ato Penitencial', 'Glória', 'Aclamação', 'Ofertório', 'Santo', 'Comunhão', 'Final'],
            'Quaresma': ['Entrada', 'Ato Penitencial', 'Aclamação', 'Ofertório', 'Santo', 'Comunhão', 'Final'],
            'Páscoa': ['Entrada', 'Ato Penitencial', 'Glória', 'Aclamação', 'Ofertório', 'Santo', 'Comunhão', 'Final'],
            'Tempo Comum': ['Entrada', 'Ato Penitencial', 'Glória', 'Aclamação', 'Ofertório', 'Santo', 'Comunhão', 'Final'],
            'Corpus Christi': ['Entrada', 'Ato Penitencial', 'Glória', 'Aclamação', 'Ofertório', 'Santo', 'Comunhão', 'Final'],
            'Grupo de Oração': ['Animação', 'Louvor', 'Espírito Santo', 'Adoração', 'Perdão', 'Pós-pregação', 'Mariana']
        };

        function logout() {
            sessionStorage.removeItem('isAuthenticated');
            window.location.href = 'login.html';
        }

        function formatarTexto(str) {
            if (!str) return '';
            return str.trim().split(' ').map(palavra => palavra.charAt(0).toUpperCase() + palavra.slice(1).toLowerCase()).join(' ');
        }

        function atualizarSugestoesDeMomento(categoria, datalistElementId) {
            const datalist = document.getElementById(datalistElementId);
            if (!datalist) return;
            datalist.innerHTML = '';
            const momentos = momentosPorCategoria[categoria] || [];
            momentos.forEach(momento => {
                const option = document.createElement('option');
                option.value = momento;
                datalist.appendChild(option);
            });
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.currentTarget.classList.add('active');
            if (tabName === 'manage') loadMusicList();
        }

        async function loadMusicList() {
            const tableBody = document.querySelector('#music-table tbody');
            tableBody.innerHTML = '<tr><td colspan="4">Carregando...</td></tr>';
            try {
                const response = await fetch('https://biblioteca-musical-catolica.onrender.com/api/musicas/all' );
                if (!response.ok) throw new Error('Falha ao carregar a lista.');
                const musicas = await response.json();
                tableBody.innerHTML = '';
                musicas.forEach(musica => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${musica.titulo}</td>
                        <td>${musica.tempo}</td>
                        <td>${musica.momento}</td>
                        <td class="actions">
                            <button class="btn-edit" onclick="editMusic('${musica._id}')">Editar</button>
                            <button class="btn-delete" onclick="deleteMusic('${musica._id}')">Excluir</button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            } catch (error) {
                tableBody.innerHTML = `<tr><td colspan="4" style="color: red;">${error.message}</td></tr>`;
            }
        }

        async function deleteMusic(id) {
            if (!confirm('Tem certeza que deseja excluir esta música?')) return;
            try {
                await fetch(`https://biblioteca-musical-catolica.onrender.com/api/musicas/${id}`, { method: 'DELETE' } );
                loadMusicList();
            } catch (error) {
                alert('Erro ao excluir a música.');
            }
        }

        const editModal = document.getElementById('edit-modal');
        const editForm = document.getElementById('edit-music-form');

        function closeEditModal() {
            editModal.style.display = 'none';
        }

        async function editMusic(id) {
            try {
                const response = await fetch(`https://biblioteca-musical-catolica.onrender.com/api/musicas/${id}` );
                if (!response.ok) throw new Error('Não foi possível carregar os dados da música.');
                const musica = await response.json();

                editForm.innerHTML = `
                    <input type="hidden" id="edit-id" value="${musica._id}">
                    <div class="form-group"><label for="edit-titulo">Título</label><input type="text" id="edit-titulo" value="${musica.titulo || ''}" required></div>
                    <div class="form-group"><label for="edit-artista">Artista</label><input type="text" id="edit-artista" value="${musica.artista || ''}"></div>
                    <div class="form-group"><label for="edit-tempo">Tempo/Categoria</label><select id="edit-tempo" required></select></div>
                    <div class="form-group"><label for="edit-momento">Momento</label><input type="text" id="edit-momento" list="edit-momentos-lista" value="${musica.momento || ''}" required><datalist id="edit-momentos-lista"></datalist></div>
                    <div class="form-group"><label for="edit-tom">Tom</label><input type="text" id="edit-tom" value="${musica.tom || ''}"></div>
                    <div class="form-group"><label for="edit-downloadUrl">Link de Download (Multitrack)</label><input type="url" id="edit-downloadUrl" value="${musica.downloadUrl || ''}" required></div>
                    <div class="form-group"><label for="edit-letraUrl">Link da Letra</label><input type="url" id="edit-letraUrl" value="${musica.letraUrl || ''}"></div>
                    <div class="form-group"><label for="edit-cifraUrl">Link da Cifra</label><input type="url" id="edit-cifraUrl" value="${musica.cifraUrl || ''}"></div>
                    <button type="submit">Salvar Alterações</button>
                `;
                
                const tempoSelect = document.getElementById('edit-tempo');
                const tempos = Object.keys(momentosPorCategoria);
                tempos.forEach(t => {
                    const option = document.createElement('option');
                    option.value = t;
                    option.textContent = t;
                    if (t === musica.tempo) option.selected = true;
                    tempoSelect.appendChild(option);
                });

                atualizarSugestoesDeMomento(tempoSelect.value, 'edit-momentos-lista');
                tempoSelect.addEventListener('change', () => atualizarSugestoesDeMomento(tempoSelect.value, 'edit-momentos-lista'));

                editModal.style.display = 'block';
            } catch (error) {
                alert(error.message);
            }
        }

        editForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const id = document.getElementById('edit-id').value;
            const dadosAtualizados = {
                titulo: formatarTexto(document.getElementById('edit-titulo').value),
                artista: formatarTexto(document.getElementById('edit-artista').value),
                tempo: document.getElementById('edit-tempo').value,
                momento: formatarTexto(document.getElementById('edit-momento').value),
                tom: document.getElementById('edit-tom').value.trim().toUpperCase(),
                downloadUrl: document.getElementById('edit-downloadUrl').value.trim(),
                letraUrl: document.getElementById('edit-letraUrl').value.trim(),
                cifraUrl: document.getElementById('edit-cifraUrl').value.trim(),
            };

            try {
                const response = await fetch(`https://biblioteca-musical-catolica.onrender.com/api/musicas/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dadosAtualizados ),
                });
                if (!response.ok) throw new Error('Falha ao salvar as alterações.');
                
                closeEditModal();
                loadMusicList();
                alert('Música atualizada com sucesso!');
            } catch (error) {
                alert(error.message);
            }
        });

        function setupFormListener() {
            const form = document.getElementById('add-music-form');
            const messageDiv = document.createElement('div');
            messageDiv.style.marginTop = '1rem';
            form.after(messageDiv);

            form.addEventListener('submit', async (event) => {
                event.preventDefault();
                messageDiv.style.display = 'none';

                const musica = {
                    titulo: formatarTexto(document.getElementById('titulo').value),
                    artista: formatarTexto(document.getElementById('artista').value),
                    tempo: document.getElementById('tempo').value,
                    momento: formatarTexto(document.getElementById('momento').value),
                    tom: document.getElementById('tom').value.trim().toUpperCase(),
                    downloadUrl: document.getElementById('downloadUrl').value.trim(),
                    letraUrl: document.getElementById('letraUrl').value.trim(),
                    cifraUrl: document.getElementById('cifraUrl').value.trim(),
                };

                try {
                    const response = await fetch('https://biblioteca-musical-catolica.onrender.com/api/musicas', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(musica ),
                    });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.message || 'Erro desconhecido.');

                    messageDiv.textContent = 'Música salva com sucesso!';
                    messageDiv.style.color = 'green';
                    form.reset();
                } catch (error) {
                    messageDiv.textContent = `Erro: ${error.message}`;
                    messageDiv.style.color = 'red';
                } finally {
                    messageDiv.style.display = 'block';
                }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            const formHtml = `
                <div class="form-group"><label for="titulo">Título</label><input type="text" id="titulo" required></div>
                <div class="form-group"><label for="artista">Artista</label><input type="text" id="artista"></div>
                <div class="form-group"><label for="tempo">Tempo/Categoria</label><select id="tempo" required><option value="" disabled selected>Selecione uma categoria</option></select></div>
                <div class="form-group"><label for="momento">Momento</label><input type="text" id="momento" list="momentos-lista" required><datalist id="momentos-lista"></datalist></div>
                <div class="form-group"><label for="tom">Tom</label><input type="text" id="tom"></div>
                <div class="form-group"><label for="downloadUrl">Link de Download (Multitrack)</label><input type="url" id="downloadUrl" required></div>
                <div class="form-group"><label for="letraUrl">Link da Letra</label><input type="url" id="letraUrl"></div>
                <div class="form-group"><label for="cifraUrl">Link da Cifra</label><input type="url" id="cifraUrl"></div>
                <button type="submit">Salvar Música</button>
            `;
            document.getElementById('add-music-form').innerHTML = formHtml;
            
            const tempoSelectAdd = document.getElementById('tempo');
            const tempos = Object.keys(momentosPorCategoria);
            tempos.forEach(t => {
                const option = document.createElement('option');
                option.value = t;
                option.textContent = t;
                tempoSelectAdd.appendChild(option);
            });
            
            tempoSelectAdd.addEventListener('change', () => atualizarSugestoesDeMomento(tempoSelectAdd.value, 'momentos-lista'));

            setupFormListener();
        });
    </script>
</body>
</html>
